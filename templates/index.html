<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biography System</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-4">
    <!-- 認證區 -->
    <div id="auth-section" class="mb-6">
      <h1 class="text-2xl font-bold mb-4">Biography System</h1>
      <div id="login-form" class="bg-white p-6 rounded shadow-md">
        <h2 class="text-xl font-semibold mb-4">登入</h2>
        <input id="login-email" type="email" placeholder="電子郵件" class="w-full p-2 mb-2 border rounded">
        <input id="login-password" type="password" placeholder="密碼" class="w-full p-2 mb-2 border rounded">
        <button onclick="login()" class="bg-blue-500 text-white p-2 rounded w-full">登入</button>
        <p class="mt-2 text-center">
          沒有帳號？<a href="#" onclick="showRegister()" class="text-blue-500">註冊</a>
        </p>
      </div>
      <div id="register-form" class="bg-white p-6 rounded shadow-md hidden">
        <h2 class="text-xl font-semibold mb-4">註冊</h2>
        <input id="register-email" type="email" placeholder="電子郵件" class="w-full p-2 mb-2 border rounded">
        <input id="register-password" type="password" placeholder="密碼" class="w-full p-2 mb-2 border rounded">
        <button onclick="register()" class="bg-green-500 text-white p-2 rounded w-full">註冊</button>
        <p class="mt-2 text-center">
          已有帳號？<a href="#" onclick="showLogin()" class="text-blue-500">登入</a>
        </p>
      </div>
    </div>

    <!-- 主功能區 -->
    <div id="main-section" class="hidden">
      <!-- 進度區 -->
      <div id="progress-section" class="bg-white p-6 rounded shadow-md mb-6">
        <h2 class="text-xl font-semibold mb-4">進度</h2>
        <p id="progress-info" class="mb-2"></p>
        <button onclick="fetchProgress()" class="bg-blue-500 text-white p-2 rounded">刷新進度</button>
      </div>

      <!-- 問題與回答區 -->
      <div id="question-section" class="bg-white p-6 rounded shadow-md mb-6">
        <h2 class="text-lg font-semibold mb-4">回答問題</h2>
        <p id="current-question" class="mb-2"></p>
        <input id="question-id" type="hidden">
        <textarea id="answer-content" placeholder="請在此輸入您的回答..." class="w-full p-2 border rounded mb-2"></textarea>
        <button onclick="submitAnswer()" class="bg-blue-500 text-white p-2 rounded w-full mb-2">提交文字回答</button>
        <div class="mb-2">
          <label class="block mb-2">或上傳音訊回答</label>
          <input id="audio-file" type="file" accept="audio/*" class="w-full p-2 border rounded mb-2">
        </div>
        <button onclick="transcribeAnswer()" class="bg-green-500 text-white p-2 rounded w-full mb-2">提交音訊回答</button>
        <div class="mb-2">
          <label class="block mb-2">或即時錄音</label>
          <button id="start-record" onclick="startRecording()" class="bg-purple-500 text-white p-2 rounded w-full mb-2" disabled>開始錄音</button>
          <button id="stop-record" onclick="stopRecordingAndUpload()" class="bg-red-500 text-white p-2 rounded w-full mb-2 hidden">停止錄音並上傳</button>
        </div>
        <button onclick="rezeroAnswer()" class="bg-red-500 text-white p-2 rounded w-full mb-2">重置回答</button>
        <button onclick="fetchNextQuestion()" class="bg-gray-500 text-white p-2 rounded w-full">獲取下一個問題</button>
      </div>
      <!-- 自傳生成與預覽區 -->
      <div id="biography-section" class="bg-white p-6 rounded shadow-md mb-6">
        <h2 class="text-lg font-semibold mb-4">生成自傳</h2>
        <div class="mb-4">
          <label class="block mb-2">風格</label>
          <select id="biography-style" class="w-full p-2 border rounded">
            <option value="自然">自然</option>
            <option value="正式">正式</option>
            <option value="文藝">文藝</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block mb-2">語言</label>
          <select id="biography-language" class="w-full p-2 border rounded">
            <option value="中文">中文</option>
            <option value="English">英文</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block mb-2">字數</label>
          <select id="biography-length" class="w-full p-2 border rounded">
            <option value="300 字">300 字</option>
            <option value="500 字">500 字</option>
            <option value="800 字">800 字</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block mb-2">用途</label>
          <select id="biography-usage" class="w-full p-2 border rounded">
            <option value="個人紀錄">個人紀錄</option>
            <option value="求職">求職</option>
            <option value="申請學校">申請學校</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block mb-2">情感</label>
          <select id="biography-emotion" class="w-full p-2 border rounded">
            <option value="積極">積極</option>
            <option value="感性">感性</option>
            <option value="勵志">勵志</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block mb-2">目的</label>
          <select id="biography-aim" class="w-full p-2 border rounded">
            <option value="展示個人成長">展示個人成長</option>
            <option value="申請學校">申請學校</option>
            <option value="分享職業歷程">分享職業歷程</option>
          </select>
        </div>
        <button onclick="generateBiography()" class="bg-green-600 text-white p-2 rounded w-full mb-2">生成自傳</button>
        <button onclick="previewBiography()" class="bg-blue-500 text-white p-2 rounded w-full">預覽自傳</button>
        <div id="biography-preview" class="mt-4 p-4 bg-gray-50 rounded"></div>
      </div>

      <!-- 計劃選擇區 -->
      <div id="plan-section" class="bg-white p-6 rounded shadow-md mb-6">
        <h2 class="text-xl font-semibold mb-4">選擇計劃</h2>
        <div id="plan-list" class="mb-4"></div>
        <select id="plan-id" class="w-full p-2 border rounded mb-2"></select>
        <button onclick="selectPlan()" class="bg-blue-500 text-white p-2 rounded w-full">選擇計劃</button>
      </div>

      <!-- 登出 -->
      <button onclick="logout()" class="bg-red-500 text-white p-2 rounded">登出</button>
    </div>
  </div>

  <script>
    let token = null;
    // 檢查麥克風權限
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(() => {
        document.getElementById('start-record').disabled = false;
      })
      .catch((error) => {
        console.error('麥克風權限錯誤:', error);
        document.getElementById('start-record').disabled = true;
        document.getElementById('start-record').textContent = '錄音不可用（無麥克風權限）';
      });
    // 切換到註冊表單
    function showRegister() {
      console.log('Showing register form');
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.remove('hidden');
    }

    // 切換到登入表單
    function showLogin() {
      console.log('Showing login form');
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
    }

    // 註冊
    async function register() {
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;

      if (!email || !password) {
        alert('請輸入電子郵件和密碼');
        return;
      }

      console.log('Sending register request:', { email, password });
      try {
        const response = await fetch('http://localhost:5000/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await response.json();
        console.log('Register response:', data);
        if (response.ok) {
          alert('註冊成功，請登入！');
          showLogin();
        } else {
          alert(data.error || '註冊失敗');
        }
      } catch (error) {
        console.error('Register error:', error);
        alert('錯誤：' + error.message);
      }
    }

    // 登入
    async function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      if (!email || !password) {
        alert('請輸入電子郵件和密碼');
        return;
      }

      console.log('Sending login request:', { email });
      try {
        const response = await fetch('http://localhost:5000/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await response.json();
        console.log('Login response:', data);
        if (response.ok) {
          token = data.token;
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('main-section').classList.remove('hidden');
          fetchNextQuestion();
          fetchProgress();
          fetchPlans();
        } else {
          alert(data.error || '登入失敗');
        }
      } catch (error) {
        console.error('Login error:', error);
        alert('錯誤：' + error.message);
      }
    }

    // 登出
    function logout() {
      console.log('Logging out');
      token = null;
      document.getElementById('auth-section').classList.remove('hidden');
      document.getElementById('main-section').classList.add('hidden');
      document.getElementById('login-email').value = '';
      document.getElementById('login-password').value = '';
      document.getElementById('biography-preview').innerHTML = '';
      document.getElementById('plan-list').innerHTML = '';
    }

    // 獲取下一個問題
    async function fetchNextQuestion() {
      console.log('Fetching next question');
      try {
        const response = await fetch('http://localhost:5000/biography/next-question', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        console.log('Next question response:', data);
        if (response.ok) {
          if (data.question) {
            document.getElementById('current-question').textContent = `問題（${data.question.theme}）：${data.question.content}`;
            document.getElementById('question-id').value = data.question.id;
          } else {
            document.getElementById('current-question').textContent = '所有問題已完成，請生成自傳！';
            document.getElementById('question-id').value = '';
          }
        } else {
          alert(data.error || '無法獲取問題');
        }
      } catch (error) {
        console.error('Fetch next question error:', error);
        alert('錯誤：' + error.message);
      }
    }

    // 提交回答
    async function submitAnswer() {
      const questionId = document.getElementById('question-id').value;
      const answer = document.getElementById('answer-content').value;

      if (!questionId || !answer) {
        alert('問題 ID 或回答內容不能為空');
        return;
      }

      console.log('Submitting answer:', { questionId, answer });
      try {
        const response = await fetch('http://localhost:5000/biography/answer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ question_id: parseInt(questionId), answer })
        });
        const data = await response.json();
        console.log('Submit answer response:', data);
        if (response.ok) {
          document.getElementById('answer-content').value = '';
          if (data.question) {
            document.getElementById('current-question').textContent = `問題（${data.question.theme}）：${data.question.content}`;
            document.getElementById('question-id').value = data.question.id;
          } else {
            document.getElementById('current-question').textContent = '所有問題已完成，請生成自傳！';
            document.getElementById('question-id').value = '';
          }
          fetchProgress();
        } else {
          alert(data.error || '提交回答失敗');
        }
      } catch (error) {
        console.error('Submit answer error:', error);
        alert('錯誤：' + error.message);
      }
    }
    async function transcribeAnswer() {
      const questionId = document.getElementById('question-id').value;
      const audioFile = document.getElementById('audio-file').files[0];

      if (!questionId) {
        alert('請先獲取一個問題');
        return;
      }
      if (!audioFile) {
        alert('請選擇音訊檔案');
        return;
      }

      const formData = new FormData();
      formData.append('file', audioFile);
      formData.append('question_id', questionId);

      try {
        const response = await fetch('http://localhost:5000/biography/transcribe', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        const data = await response.json();
        console.log('音訊回答回應:', data);
        if (response.ok) {
          alert(`音訊回答已儲存：${data.transcription}`);
          if (data.question) {
            document.getElementById('current-question').textContent = data.question.content;
            document.getElementById('question-id').value = data.question.id;
            document.getElementById('audio-file').value = ''; // 清空檔案輸入
          } else {
            document.getElementById('current-question').textContent = '所有問題已完成，可生成自傳';
            document.getElementById('question-id').value = '';
          }
        } else {
          alert(data.error || '提交音訊回答失敗');
        }
      } catch (error) {
        console.error('音訊回答錯誤:', error);
        alert('錯誤：' + error.message);
      }
    }

    // 重新開始問答
    async function rezeroAnswer() {
      if (!confirm('確定要重新開始問答？這將清除所有問題和回答記錄！')) {
        return;
      }

      console.log('Resetting questions and answers');
      try {
        const response = await fetch('http://localhost:5000/biography/reset', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();
        console.log('Reset response:', data);
        if (response.ok) {
          alert('問答已重置！');
          document.getElementById('current-question').textContent = '';
          document.getElementById('question-id').value = '';
          document.getElementById('answer-content').value = '';
          fetchNextQuestion();
          fetchProgress();
        } else {
          alert(data.error || '重置失敗');
        }
      } catch (error) {
        console.error('Reset error:', error);
        alert('錯誤：' + error.message);
      }
    }
    
    let mediaRecorder = null;
    let audioChunks = [];

    async function startRecording() {
      const questionId = document.getElementById('question-id').value;
      if (!questionId) {
        alert('請先獲取一個問題');
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        mediaRecorder.start();
        document.getElementById('start-record').classList.add('hidden');
        document.getElementById('stop-record').classList.remove('hidden');
      } catch (error) {
        console.error('錄音錯誤:', error);
        alert('無法開始錄音：請檢查麥克風權限');
      }
    }

    async function stopRecordingAndUpload() {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        alert('尚未開始錄音');
        return;
      }

      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
      document.getElementById('start-record').classList.remove('hidden');
      document.getElementById('stop-record').classList.add('hidden');

      mediaRecorder.onstop = async () => {
        const questionId = document.getElementById('question-id').value;
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const formData = new FormData();
        formData.append('file', audioBlob, 'recording.webm');
        formData.append('question_id', questionId);

        try {
          const response = await fetch('http://localhost:5000/biography/transcribe', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          });
          const data = await response.json();
          console.log('錄音回答回應:', data);
          if (response.ok) {
            alert(`錄音回答已儲存：${data.transcription}`);
            if (data.question) {
              document.getElementById('current-question').textContent = data.question.content;
              document.getElementById('question-id').value = data.question.id;
            } else {
              document.getElementById('current-question').textContent = '所有問題已完成，可生成自傳';
              document.getElementById('question-id').value = '';
            }
          } else {
            alert(data.error || '提交錄音回答失敗');
          }
        } catch (error) {
          console.error('錄音上傳錯誤:', error);
          alert('錯誤：' + error.message);
        }

        audioChunks = []; // 清空錄音片段
      };
    }

    // 獲取進度
    async function fetchProgress() {
      console.log('Fetching progress');
      try {
        const response = await fetch('http://localhost:5000/biography/progress', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        console.log('Progress response:', data);
        if (response.ok) {
          const progressInfo = `
            總問題數：${data.total_questions}<br>
            已回答問題數：${data.answered_questions}<br>
            回答總字數：${data.total_length}<br>
            完成百分比：${data.completion_percentage.toFixed(2)}%
          `;
          document.getElementById('progress-info').innerHTML = progressInfo;
        } else {
          alert(data.error || '無法獲取進度');
        }
      } catch (error) {
        console.error('Fetch progress error:', error);
        alert('錯誤：' + error.message);
      }
    }

    // 生成自傳
    async function generateBiography() {
      const style = document.getElementById('biography-style').value;
      const language = document.getElementById('biography-language').value;
      const length = document.getElementById('biography-length').value;
      const usage = document.getElementById('biography-usage').value;
      const emotion = document.getElementById('biography-emotion').value;
      const aim = document.getElementById('biography-aim').value;

      console.log('生成自傳:', { style, language, length, usage, emotion, aim });
      try {
        const response = await fetch('http://localhost:5000/biography/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ style, language, length, usage, emotion, aim })
        });
        const data = await response.json();
        console.log('生成自傳回應:', data);
        if (response.ok) {
          alert('自傳生成成功！');
          previewBiography();
        } else {
          alert(data.error || '生成自傳失敗');
        }
      } catch (error) {
        console.error('生成自傳錯誤:', error);
        alert('錯誤：' + error.message);
      }
    }

    // 預覽自傳
    async function previewBiography() {
      console.log('Previewing biography');
      try {
        const response = await fetch('http://localhost:5000/biography/preview', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        console.log('Preview biography response:', data);
        if (response.ok) {
          document.getElementById('biography-preview').innerHTML = `
            <h3 class="text-lg font-semibold mb-2">最新自傳（${data.biography.style}，${data.biography.created_at}）</h3>
            <p>${data.biography.content.replace(/\n/g, '<br>')}</p>
          `;
        } else {
          alert(data.error || '無法預覽自傳');
        }
      } catch (error) {
        console.error('Preview biography error:', error);
        alert('錯誤：' + error.message);
      }
    }

    // 獲取計劃列表
    async function fetchPlans() {
      console.log('Fetching plans');
      try {
        const response = await fetch('http://localhost:5000/plans/plans', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        console.log('Plans response:', data);
        if (response.ok) {
          const planList = document.getElementById('plan-list');
          const planSelect = document.getElementById('plan-id');
          planList.innerHTML = '';
          planSelect.innerHTML = '';
          data.plans.forEach(plan => {
            planList.innerHTML += `<p>${plan.name} (字數限制：${plan.word_limit || '無限制'})</p>`;
            const option = document.createElement('option');
            option.value = plan.id;
            option.textContent = plan.name;
            planSelect.appendChild(option);
          });
        } else {
          alert(data.error || '無法獲取計劃');
        }
      } catch (error) {
        console.error('Fetch plans error:', error);
        alert('錯誤：' + error.message);
      }
    }

    // 選擇計劃
    async function selectPlan() {
      const planId = document.getElementById('plan-id').value;

      console.log('Selecting plan:', { planId });
      try {
        const response = await fetch('http://localhost:5000/plans/select-plan', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ plan_id: parseInt(planId) })
        });
        const data = await response.json();
        console.log('Select plan response:', data);
        if (response.ok) {
          alert('計劃選擇成功！');
          fetchPlans();
        } else {
          alert(data.error || '選擇計劃失敗');
        }
      } catch (error) {
        console.error('Select plan error:', error);
        alert('錯誤：' + error.message);
      }
    }
  </script>
</body>
</html>