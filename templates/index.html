<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>我的生命故事</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 6px;
    }
    .progress-bar > div {
      height: 100%;
      background: linear-gradient(to right, #60a5fa, #6366f1);
    }
    .star {
      font-size: 20px;
      color: #e5e7eb;
    }
    .star.on {
      color: #fbbf24;
    }
    #preview-content img {
      max-width: 100%;
      height: auto;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .title-glow {
      text-shadow: 0 0 20px rgba(219, 39, 119, 0.3);
    }

    .subtitle-fade {
      opacity: 0.8;
      transition: opacity 0.3s ease;
    }
    body {
      font-family: 'Noto Sans TC', sans-serif;
    }
    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(40px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-fadeInUp {
      animation: fadeInUp 0.8s ease-out;
    }
    /* 在 style 標籤中加入 */
    @keyframes slideInFromLeft {
      0% { opacity: 0; transform: translateX(-50px); }
      100% { opacity: 1; transform: translateX(0); }
    }

    .animate-slideIn { animation: slideInFromLeft 0.6s ease-out; }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .animate-float { animation: float 3s ease-in-out infinite; }
  </style>
</head>
<body class="bg-gradient-to-r from-pink-100 via-orange-100 to-yellow-100 min-h-screen">
  <!-- Header -->
  <div id="cover-section" class="flex flex-col justify-center items-center h-screen bg-gradient-to-r from-pink-100 via-orange-100 to-yellow-100 text-center px-4 overflow-auto">
    
    <!-- 插圖與標題 -->
    <img src="/static/img/cover.png" class="w-60 mb-6 animate-float animate-fadeInUp" alt="封面插圖">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">我的人生故事</h1>
    <p class="text-gray-600 text-lg mb-6">每一段經歷，都是值得訴說的篇章</p>

    <!-- CTA 按鈕 -->
    <button onclick="showLoginSection()" class="px-8 py-4 bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 font-medium">
      ✨ 開始書寫我的故事
    </button>

    <!-- 功能預覽卡片區塊 -->
    <div id="feature-preview" class="mt-10 grid grid-cols-1 md:grid-cols-3 gap-6 px-10">
      <div class="bg-white shadow-xl rounded-2xl p-6 text-left hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 border border-pink-100">
        <!-- 將每個卡片的標題改為 -->
        <h3 class="text-lg font-semibold mb-2 flex items-center">
          <span class="text-2xl mr-2 bg-gradient-to-r from-pink-400 to-orange-400 bg-clip-text text-transparent">📊</span>
          創作進度
        </h3>
        <p class="text-gray-600 text-sm">隨時查看答題數量與進度完成率，追蹤你的人生故事。</p>
      </div>
      <div class="bg-white shadow-lg rounded-xl p-6 text-left hover:shadow-xl transition">
        <h3 class="text-lg font-semibold mb-2 flex items-center">
          <span class="text-2xl mr-2 bg-gradient-to-r from-pink-400 to-orange-400 bg-clip-text text-transparent">📝</span>
          自傳生成
        </h3>
        <p class="text-gray-600 text-sm">選擇風格與用途，立即轉換你的答覆為動人自傳。</p>
      </div>
      <div class="bg-white shadow-lg rounded-xl p-6 text-left hover:shadow-xl transition">
        <h3 class="text-lg font-semibold mb-2 flex items-center">
          <span class="text-2xl mr-2 bg-gradient-to-r from-pink-400 to-orange-400 bg-clip-text text-transparent">📂</span>
          歷史紀錄
        </h3>
        <p class="text-gray-600 text-sm">保存並預覽過去生成的所有版本，方便管理與比對。</p>
      </div>
    </div> 

    <!-- 理念介紹 -->
    <div class="mt-20 bg-white/60 backdrop-blur-sm rounded-2xl p-8 shadow-lg border border-white/20">
      <h2 class="text-3xl font-bold mb-6 bg-gradient-to-r from-pink-600 via-orange-500 to-yellow-500 bg-clip-text text-transparent"></h2>
      <p class="text-lg leading-relaxed text-gray-700">
        每個人都有屬於自己的故事，只是從來沒有機會被好好說出來。<br/>
        <span class="text-pink-600 font-medium">YouSayWrite</span> 幫助你透過簡單的提問與引導，將記憶化為文字、將經歷寫成自傳。<br/>
        無論是為了自己、家人、或未來的某一天，我們都相信：<br/>
        <em>「記錄，就是尊重與保存。」</em>
      </p>
    </div>

  </div>
</body>

  <!-- Loading Overlay & Alert -->
  <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center hidden z-50">
    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-solid"></div>
  </div>
  <div id="alert-box" class="fixed top-5 right-5 hidden p-4 mb-4 text-sm rounded-lg shadow-lg z-50" role="alert"></div>

  <!-- Auth Section -->
<div id="auth-section" class="hidden flex justify-center items-center min-h-screen bg-gradient-to-r from-pink-100 via-orange-100 to-yellow-100">
    <div id="login-form" class="bg-white p-6 rounded-2xl shadow-lg ring-1 ring-gray-100 w-full max-w-md">
      <h2 class="text-2xl font-semibold mb-4">登入</h2>
      <div class="relative mb-2">
        <input id="login-email" type="email" placeholder="電子郵件" class="w-full p-2 pl-10 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
        <span class="absolute left-3 top-2.5 text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12H8m0 0l4 4m-4-4l4-4" />
          </svg>
        </span>
      </div>
      <input id="login-password" type="password" placeholder="密碼" class="w-full p-2 mb-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
      <button onclick="login()" class="bg-blue-500 hover:bg-blue-600 transition duration-300 text-white p-2 rounded w-full">登入</button>
      <p class="mt-2 text-center text-sm text-gray-600">
        沒有帳號？<a href="#" onclick="showRegister()" class="text-blue-500 hover:underline">註冊</a>
      </p>
    </div>
    <!-- 註冊表單 -->
    <div id="register-form" class="hidden bg-white p-6 rounded-2xl shadow-lg ring-1 ring-gray-100 max-w-md w-full mx-auto mt-4">
      <h2 class="text-2xl font-semibold mb-4">註冊</h2>
      <input id="register-email" type="email" placeholder="電子郵件" class="w-full p-2 mb-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
      <input id="register-password" type="password" placeholder="密碼" class="w-full p-2 mb-4 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
      <button onclick="register()" class="bg-blue-500 hover:bg-blue-600 transition duration-300 text-white p-2 rounded w-full">註冊</button>
      <p class="mt-2 text-center text-sm text-gray-600">
        已經有帳號？<a href="#" onclick="showLogin()" class="text-blue-500 hover:underline">登入</a>
      </p>
    </div>
  </div>

  <div id="main-section" class="hidden min-h-screen">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <div class="w-64 bg-white shadow-lg p-4 space-y-4 min-h-screen">
        <div class="flex items-center mb-6 p-4 bg-gradient-to-br from-orange-100 via-pink-100 to-rose-100 rounded-2xl shadow-inner">
          <div class="w-12 h-12 bg-gradient-to-r from-orange-400 to-pink-400 rounded-full flex items-center justify-center text-white text-xl">
            👤
          </div>
          <div class="ml-3">
            <p class="font-medium text-gray-800">歡迎回來</p>
            <p class="text-sm text-gray-600">開始書寫你的故事</p>
          </div>
        </div>
        <h2 class="text-xl font-semibold mb-2">功能選單</h2>
        <button onclick="showSection('progress')" class="w-full text-left p-2 rounded hover:bg-blue-100">📊 進度</button>
        <button onclick="showSection('biography')" class="w-full text-left p-2 rounded hover:bg-blue-100">📝 生成自傳</button>
        <button onclick="showSection('plans')" class="w-full text-left p-2 rounded hover:bg-blue-100">📌 選擇計畫</button>
        <button onclick="showSection('history')" class="w-full text-left p-2 rounded hover:bg-blue-100">📂 自傳紀錄</button>
        <button onclick="logout()" class="w-full text-left p-2 mt-4 bg-red-500 hover:bg-red-600 text-white rounded">登出</button>
      </div>

      <!-- 主功能區 -->
      <div class="flex-1 p-6 space-y-6 bg-gray-50 overflow-auto">
        <!-- 進度區 -->
        <div id="history-section" class="hidden bg-white p-6 rounded shadow-md">
          <h2 class="text-xl font-bold mb-4">📂自傳紀錄</h2>
          <div id="biography-history-list" class="space-y-4 text-sm text-gray-700">尚未載入</div>
        </div>

        <!-- 替換進度信息顯示 -->
  <div id="progress-section" class="hidden bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-xl shadow-lg">
    …
    <div class="bg-white p-4 rounded-lg shadow-sm">
        <div id="progress-info" class="my-4 p-4 rounded-xl shadow bg-white/60"></div>
    </div>
    <p class="text-center text-xs text-gray-500 mt-2">持續創作，故事會更精彩！</p>

    <!-- ⭐ 按鈕放這裡 -->
    <button
        onclick="loadQuestionSection()"
        class="mt-4 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600
              text-white p-2 rounded-lg w-full transition-all duration-200 transform hover:scale-105">
        ✨ 繼續回答問題
    </button>
  </div>

        <!-- 問題與回答區 -->
        <div id="question-section" class="bg-gradient-to-br from-pink-50 to-orange-50 p-6 rounded-2xl shadow-lg border border-pink-100 space-y-4">
          <div class="flex items-center mb-4">
            <span class="text-3xl mr-3">💭</span>
            <div>
              <h2 class="text-xl font-semibold text-gray-800">讓我們聊聊你的故事</h2>
              <p class="text-sm text-gray-600">每個回答都是珍貴的回憶片段</p>
            </div>
          </div>
            <div class="bg-white/80 backdrop-blur-sm p-4 rounded-xl border border-pink-100 shadow-sm">
              <p id="current-question" class="text-gray-800 font-medium text-lg leading-relaxed"></p>
            </div>
            <input id="question-id" type="hidden">

          <!-- 🎙️ 錄音按鈕放輸入框上方 -->
          <div id="record-controls" class="mb-2">
            <button id="start-record" onclick="startRecording()" class="bg-gradient-to-r from-purple-400 to-pink-400 hover:from-purple-500 hover:to-pink-500 text-white p-3 rounded-xl w-full transition-all duration-300 transform hover:scale-105 shadow-md">🎙️ 開始錄音</button>
            <button id="stop-record" onclick="stopRecordingAndUpload()" class="bg-gradient-to-r from-red-400 to-rose-400 hover:from-red-500 hover:to-rose-500 text-white p-3 rounded-xl w-full hidden transition-all duration-300 transform hover:scale-105 shadow-md">⏹️ 停止錄音並上傳</button>
          </div>
          <!-- 輸入框 -->
          <!-- 回答段落容器 -->
          <div id="answer-paragraphs" class="space-y-2 max-h-40 overflow-y-auto text-gray-700 font-medium"></div>
          <textarea id="answer-content" placeholder="請在此輸入您的回答..." class="w-full p-4 border-2 border-pink-200 rounded-xl focus:border-pink-400 focus:ring-2 focus:ring-pink-200 focus:outline-none resize-none h-32 bg-white/80 backdrop-blur-sm"></textarea>

          <!-- 提交與清空：並排 -->
          <div class="flex space-x-3">
            <button onclick="submitAnswer()" class="flex-1 bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 text-white p-3 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-md font-medium">✨ 完成回答</button>
            <button onclick="clearAnswer()" class="bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 text-gray-700 p-3 rounded-xl transition-all duration-300 hover:shadow-md">🗑️ 清空</button>
          </div>
          <button onclick="rezeroAnswer()" class=" bg-gradient-to-r from-red-300 to-pink-250 hover:from-red-300 hover:to-pink-200 text-white p-3 rounded-xl w-full transition-all duration-300 transform hover:scale-105 shadow-md font-medium">重置回答</button>

          <div class="mb-2">
            <label class="block mb-2">或上傳音訊回答</label>
            <input id="audio-file" type="file" accept="audio/*" class="w-full p-2 border rounded mb-2">
          </div>
          <button onclick="transcribeAnswer()" class="hidden bg-gradient-to-r from-green-400 to-emerald-500...">🎵 提交音訊回答</button>
          
          <button onclick="fetchNextQuestion()" class="hidden bg-gray-500 text-white...">獲取下一個問題</button>

        </div>
        <div id="image-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
          <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-xl">
            <h3 class="text-lg font-bold mb-4 text-gray-800">📷 是否想為這段回答上傳一張圖片？</h3>
            <input id="image-file" type="file" accept="image/*" class="w-full mb-4 border p-2 rounded" />
            <div class="flex justify-end space-x-3">
              <button onclick="cancelImageUpload()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-gray-800">略過</button>
              <button onclick="uploadAnswerImage()" class="px-4 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded">上傳圖片</button>
            </div>
        </div>
        </div>
        <!-- 自傳生成與預覽區 -->
        <div id="biography-section" class="hidden bg-white p-6 rounded shadow-md">
          <h2 class="text-xl font-bold mb-4">生成自傳</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block mb-1 font-medium">風格</label>
              <select id="biography-style" class="w-full p-2 border rounded">
                <option value="自然">自然</option>
                <option value="正式">正式</option>
                <option value="文藝">文藝</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 font-medium">語言</label>
              <select id="biography-language" class="w-full p-2 border rounded">
                <option value="中文">中文</option>
                <option value="English">英文</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 font-medium">字數</label>
              <select id="biography-length" class="w-full p-2 border rounded">
                <option value="300 字">300 字</option>
                <option value="500 字">500 字</option>
                <option value="800 字">800 字</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 font-medium">用途</label>
              <select id="biography-usage" class="w-full p-2 border rounded">
                <option value="個人紀錄">個人紀錄</option>
                <option value="求職">求職</option>
                <option value="申請學校">申請學校</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 font-medium">情感</label>
              <select id="biography-emotion" class="w-full p-2 border rounded">
                <option value="積極">積極</option>
                <option value="感性">感性</option>
                <option value="勵志">勵志</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 font-medium">目的</label>
              <select id="biography-aim" class="w-full p-2 border rounded">
                <option value="展示個人成長">展示個人成長</option>
                <option value="申請學校">申請學校</option>
                <option value="分享職業歷程">分享職業歷程</option>
              </select>
            </div>
          </div>
          <button onclick="generateBiography()" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded w-full mb-2">生成自傳</button>
          <button onclick="previewLatestBiography()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded w-full">預覽自傳</button>
          <div id="loading-message" class="hidden mt-2 text-center text-gray-600">✍️ 自傳生成中，請稍候...</div>
          <div id="preview-wrapper" class="hidden mt-4">
            <textarea id="preview-content" class="w-full h-64 p-4 border rounded resize-none" readonly></textarea>
        </div>

        <!-- 計劃選擇區 -->
        <div id="plans-section" class="hidden bg-white p-6 rounded shadow-md">
          <h2 class="text-xl font-bold mb-4">計畫選擇</h2>
          <div id="plan-list" class="mb-4 text-sm text-gray-600">尚未載入計畫列表</div>
          <select id="plan-id" class="w-full p-2 border rounded mb-2"></select>
          <button onclick="selectPlan()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded w-full">選擇計畫</button>
        </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('main-section').classList.add('hidden');
      document.getElementById('cover-section').classList.remove('hidden');
    });
    function showLoginSection() {
      document.getElementById('cover-section').classList.add('hidden');
      document.getElementById('auth-section').classList.remove('hidden');
      document.getElementById('feature-preview').classList.remove('hidden');
    }


    let token = null;
    // 檢查麥克風權限
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(() => {
        document.getElementById('start-record').disabled = false;
      })
      .catch((error) => {
        console.error('麥克風權限錯誤:', error);
        document.getElementById('start-record').disabled = true;
        document.getElementById('start-record').textContent = '錄音不可用（無麥克風權限）';
      });
    // 切換到註冊表單
    function showRegister() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.remove('hidden');
    }
    function clearAnswer() {
    document.getElementById('answer-content').value = '';
    }
    // 切換到登入表單
    function showLogin() {
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
    }
    function showAlert(message, type = 'success') {
      const box = document.getElementById('alert-box');
      box.textContent = message;
      box.className = `fixed top-5 right-5 p-4 mb-4 text-sm rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
      }`;
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 3000);
    }

    function showLoading(show = true) {
      document.getElementById('loading-overlay').classList.toggle('hidden', !show);
    }

    function insertParagraph(text) {
      const container = document.getElementById('answer-paragraphs');
      const p = document.createElement('div');
      p.className = 'flex justify-between items-center bg-gradient-to-r from-pink-50 to-orange-50 p-3 rounded-xl shadow-sm border border-pink-200 animate-fadeInUp';
      p.innerHTML = `
        <span class="text-gray-800 flex-1">${text}</span>
        <button onclick="this.parentElement.remove()" class="ml-2 text-red-500 hover:text-red-700">❌</button>
      `;
      container.appendChild(p);
    }
    async function fetchBiographyHistory() {
      try {
        const response = await fetch("http://localhost:5000/biography/versions", {
          headers: { Authorization: "Bearer " + token }
        });
        const data = await response.json();
        const list = document.getElementById("biography-history-list");
        console.log("📦 versions:", data.versions);
        if (response.ok) {
          list.innerHTML = data.versions.map(b => `
            <div class="p-3 border rounded shadow-sm">
              <input id="title-${b.id}" value="${b.title || '未設定標題'}" 
                    class="font-medium w-full border-b mb-2" 
                    onchange="saveBiographyTitle(${b.id})">
              <p class="text-xs text-gray-500">
                風格：${b.style || '未知'}　語言：${b.language || '未知'}　時間：${new Date(b.created_at).toLocaleString('zh-TW', { hour12: false })}
              </p>
              <button onclick="toggleBiography(this, ${b.id})">查看全文</button>
              <div id="export-content-${b.id}" class="hidden overflow-hidden max-h-0 p-4 border rounded bg-white text-gray-800"></div>
            </div>
          `).join('');
        } else {
          list.innerHTML = `<p class="text-red-500">${data.error}</p>`;
        } 
      } catch (e) {
        console.error("載入失敗", e);
      }
    }

    const biographyLoaded = {};      // 記錄已載入 id
    const biographyExpanded = {};    // 記錄展開狀態

    async function toggleBiography(button, id) {
      function renderBiographyContent(content) {
      content = content.replace(/!\[.*?\]\((static\/uploads[^)]+)\)/g,
        '<br><img src="http://localhost:5000/$1" alt="圖片" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 5px;"><br>');
      content = content.replace(/\n/g, '<br>');
      return content;
      }
      const container = document.getElementById(`export-content-${id}`);
      container.style.overflow = 'hidden';
      if (!biographyLoaded[id]) {
        try {
          const res = await fetch(`http://localhost:5000/biography/export/${id}?format=txt`, {
            headers: { Authorization: "Bearer " + token }
          });
          const text = await res.text();
          const rendered = renderBiographyContent(text);

          container.innerHTML = rendered;
          container.classList.remove("hidden", "max-h-0");

          container.classList.add("max-h-[1000px]");

          button.textContent = "收合內容";
          biographyLoaded[id] = true;
          biographyExpanded[id] = true;
        } catch (e) {
          console.error("載入失敗", e);
          alert("載入自傳失敗");
        }
      } else {
        if (biographyExpanded[id]) {
          container.style.display = 'none'; 
          button.textContent = "查看全文";
          biographyExpanded[id] = false;
        } else {
          container.style.display = 'block';
          button.textContent = "收合內容";
          biographyExpanded[id] = true;
        }
      }
    }


    // 註冊
    async function register() {
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;

      if (!email || !password) {
        alert('請輸入電子郵件和密碼');
        return;
      }

      console.log('Sending register request:', { email, password });
      try {
        const response = await fetch('http://localhost:5000/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await response.json();
        console.log('Register response:', data);
        if (response.ok) {
          alert('註冊成功，請登入！');
          showLogin();
        } else {
          alert(data.error || '註冊失敗');
        }
      } catch (error) {
        console.error('Register error:', error);
        alert('錯誤：' + error.message);
      }
    }

    // 登入
    async function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      if (!email || !password) {
        alert('請輸入電子郵件和密碼');
        return;
      }

      console.log('Sending login request:', { email });
      try {
        const response = await fetch('http://localhost:5000/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await response.json();
        console.log('Login response:', data);
        if (response.ok) {
          token = data.token;
          localStorage.setItem("token", data.token);
          showAlert("登入成功！");
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('main-section').classList.remove('hidden');
          showSection('progress');  // 新增這行，直接顯示進度畫面
          fetchProgress();
          fetchPlans();
          fetchNextQuestion();
        } else {
          alert(data.error || '登入失敗');
        }
      } catch (error) {
        console.error('Login error:', error);
        alert('錯誤：' + error.message);
      }
    }

    // 登出
    async function loadBiographyHistory() {
      const token = localStorage.getItem("token");
      const res = await fetch("http://localhost:5000/biography/versions", {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await res.json();

      const container = document.getElementById("biography-list");
      container.innerHTML = "";

      if (data.versions) {
        const versions = data.versions;
        data.versions.forEach(entry => {
          const div = document.createElement("div");
          div.className = "p-4 border rounded shadow-sm";

          const titleInput = document.createElement("input");
          titleInput.value = entry.title || "未命名自傳";
          titleInput.id = `title-${b.id}`;
          titleInput.className = "text-lg font-semibold w-full border-b mb-2";
          titleInput.onchange = () => updateBiographyTitle(entry.id, titleInput.value);
          alert("✅ 已更新標題！");

          const contentPreview = document.createElement("p");
          contentPreview.textContent = `風格: ${entry.style}, 語言: ${entry.language}, 時間: ${date}`;
          contentPreview.className = "text-sm text-gray-600";

          div.appendChild(titleInput);
          div.appendChild(contentPreview);
          container.appendChild(div);
        });
      } else {
        container.innerHTML = "<p class='text-gray-600'>尚未生成任何自傳</p>";
      }
    }

    async function updateBiographyTitle(biographyId, newTitle) {
      const token = localStorage.getItem("token");
      await fetch("http://localhost:5000/biography/edit", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ biography_id: biographyId, title: newTitle })
      });
      const data = await res.json();
      if (!res.ok) {
        alert("❌ 修改失敗：" + data.error);
      }
    }
    function showSection(section) {
      ['progress', 'biography', 'plans','history'].forEach(id => {
        document.getElementById(`${id}-section`).classList.add('hidden');
      });
      document.getElementById('question-section').classList.add('hidden');
      document.getElementById(`${section}-section`).classList.remove('hidden');
      if (section === 'history') fetchBiographyHistory();
    }
    function loadQuestionSection() {
      showSection('progress');
      document.getElementById('question-section').classList.remove('hidden');
    }
    function logout() {
      console.log('Logging out');
      token = null;
      document.getElementById('auth-section').classList.remove('hidden');
      document.getElementById('main-section').classList.add('hidden');
      document.getElementById('login-email').value = '';
      document.getElementById('login-password').value = '';
      document.getElementById('plan-list').innerHTML = '';
    }

    // 獲取下一個問題
    async function fetchNextQuestion() {
      console.log('Fetching next question');
      try {
        const response = await fetch('http://localhost:5000/biography/next-question', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        console.log('Next question response:', data);
        if (response.ok) {
          if (data.question) {
            document.getElementById('current-question').textContent = `問題（${data.question.theme}）：${data.question.content}`;
            document.getElementById('question-id').value = data.question.id;
            document.getElementById('answer-paragraphs').innerHTML = '';
          } else {
            document.getElementById('current-question').textContent = '🎉 所有問題已完成！現在可以生成自傳了';
            document.getElementById('question-id').value = '';
            showSection('biography');
          }
        } else {
          alert(data.error || '無法獲取問題');
        }
      } catch (error) {
        console.error('Fetch next question error:', error);
        alert('錯誤：' + error.message);
      }
    }
    async function saveBiographyTitle(id) {
      const title = document.getElementById(`title-${id}`).value.trim();
      try {
        const res = await fetch("http://localhost:5000/biography/edit", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify({ biography_id: id, title: title || null })
        });
        const data = await res.json();
        if (res.ok) {
          alert("✅ 名稱已儲存！");
        } else {
          alert("❌ 儲存失敗：" + data.error);
        }
      } catch (e) {
        alert("❌ 發生錯誤：" + e.message);
      }
    }

    // 提交回答
     async function submitAnswer() {
      const questionId = document.getElementById('question-id').value;
      const answer = getFullAnswerText();

      if (!questionId || !answer) {
        alert('問題 ID 或回答內容不能為空');
        return;
      }

      try {
        const response = await fetch('http://localhost:5000/biography/answer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ question_id: parseInt(questionId), answer })
        });
        const data = await response.json();
        if (response.ok) {
          document.getElementById('answer-content').value = '';
          const aqi = data.aqi ?? 0;
          showAlert(`✅ 已提交！本次 AQI：${(aqi * 100).toFixed(1)} 分`, 'success');
          document.getElementById('image-upload-modal').classList.remove('hidden');
          sessionStorage.setItem('lastQuestionId', questionId);
          await fetchProgress();
        } else {
          alert(data.error || '提交回答失敗');
        } 
      } catch (error) {
        console.error('Submit answer error:', error);
        alert('錯誤：' + error.message);
      }
    }
    async function transcribeAnswer() {
      const questionId = document.getElementById('question-id').value;
      const audioFile = document.getElementById('audio-file').files[0];

      if (!questionId) {
        alert('請先獲取一個問題');
        return;
      }
      if (!audioFile) {
        alert('請選擇音訊檔案');
        return;
      }

      const formData = new FormData();
      formData.append('file', audioFile);
      formData.append('question_id', questionId);

      try {
        const response = await fetch('http://localhost:5000/biography/transcribe', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        const data = await response.json();
        console.log('音訊回答回應:', data);
        if (response.ok) {
          alert(`音訊回答已儲存：${data.transcription}`);
          if (data.question) {
            document.getElementById('current-question').textContent = data.question.content;
            document.getElementById('question-id').value = data.question.id;
            document.getElementById('audio-file').value = ''; // 清空檔案輸入
          } else {
            document.getElementById('current-question').textContent = '所有問題已完成，可生成自傳';
            document.getElementById('question-id').value = '';
          }
        } else {
          alert(data.error || '提交音訊回答失敗');
        }
      } catch (error) {
        console.error('音訊回答錯誤:', error);
        alert('錯誤：' + error.message);
      }
    }
    function cancelImageUpload() {
      document.getElementById('image-upload-modal').classList.add('hidden');
      fetchNextQuestion();
    }
    async function uploadAnswerImage() {
      const file = document.getElementById('image-file').files[0];
      const questionId = sessionStorage.getItem('lastQuestionId');

      if (!file || !questionId) {
        alert('請選擇圖片');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('question_id', questionId);

      try {
        const response = await fetch('http://localhost:5000/biography/answer/image', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error('伺服器回傳非 JSON：\n' + text);
        }

        const data = await response.json();
        if (response.ok) {
          showAlert('✅ 圖片上傳成功！');
          document.getElementById('image-upload-modal').classList.add('hidden');
          fetchNextQuestion();
        } else {
          alert(data.error || '圖片上傳失敗');
        }
      } catch (e) {
        alert('上傳錯誤：' + e.message);
      }
    }
    // 重新開始問答
    async function rezeroAnswer() {
      if (!confirm('確定要重新開始問答？這將清除所有問題和回答記錄！')) {
        return;
      }

      console.log('Resetting questions and answers');
      try {
        const response = await fetch('http://localhost:5000/biography/reset', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();
        console.log('Reset response:', data);
        if (response.ok) {
          alert('問答已重置！');
          document.getElementById('current-question').textContent = '';
          document.getElementById('question-id').value = '';
          document.getElementById('answer-content').value = '';
          fetchNextQuestion();
          fetchProgress();
        } else {
          alert(data.error || '重置失敗');
        }
      } catch (error) {
        console.error('Reset error:', error);
        alert('錯誤：' + error.message);
      }
    }
    
    let mediaRecorder = null;
    let audioChunks = [];
    let currentStream = null;

    async function startRecording() {
      const questionId = document.getElementById('question-id').value;
      if (!questionId) {
        alert('請先獲取一個問題');
        return;
      }

        try {
          currentStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(currentStream);
                // 設定錄音格式為 WAV 或 MP3
          const options = { mimeType: 'audio/webm;codecs=opus' };
          if (!MediaRecorder.isTypeSupported(options.mimeType)) {
            options.mimeType = 'audio/webm';
          }
          mediaRecorder = new MediaRecorder(currentStream, options);

          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              audioChunks.push(event.data);
            }
          };

          // 新增：即時轉換處理
          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            await transcribeToTextArea(audioBlob);  // 新增的函數
            audioChunks = [];
          };

          mediaRecorder.start();
          document.getElementById('start-record').classList.add('hidden');
          document.getElementById('stop-record').classList.remove('hidden');
        } catch (error) {
          console.error('錄音錯誤:', error);
          alert('無法開始錄音：請檢查麥克風權限');
        }
      }
      // 新增這個函數，用於即時轉換並顯示在文字框
    async function transcribeToTextArea(audioBlob) {
      const formData = new FormData();
      formData.append('file', audioBlob, 'recording.webm');
      
      try {
        const response = await fetch('http://localhost:5000/biography/transcribe-only', {
          method: 'POST',
          headers: {
            Authorization: 'Bearer ' + localStorage.getItem('token')
          },
          body: formData
        });

        const data = await response.json();
        console.log('轉錄回應:', data); // 加上這行來看詳細錯誤
        
        if (data.transcription) {
          insertParagraph(data.transcription);
        } else {
          console.error('轉錄失敗:', data); // 加上這行
          showAlert('語音轉換失敗: ' + (data.error || '未知錯誤'), 'error');
        }
      } catch (error) {
        console.error('網路錯誤:', error); // 加上這行
        showAlert('網路連接失敗，請檢查後端服務是否啟動', 'error');
      }
    }

    function getFullAnswerText() {
      const container = document.getElementById('answer-paragraphs');
      const paragraphs = Array.from(container.querySelectorAll('span'));
      const paragraphText = paragraphs.map(p => p.textContent.trim()).join('\n').trim();

      if (paragraphText) {
        return paragraphText;
      }

      // 若無段落，回傳 textarea 輸入內容
      return document.getElementById('answer-content').value.trim();
    }

    
    async function stopRecordingAndUpload() {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        alert('尚未開始錄音');
        return;
      }

      mediaRecorder.stop();
      if (mediaRecorder.stream) {
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
      }
      
      document.getElementById('start-record').classList.remove('hidden');
      document.getElementById('stop-record').classList.add('hidden');
      
      showAlert('正在轉換語音並提交答案，請稍候...', 'success');
      
      // 新增：等待錄音處理完成後自動提交
      setTimeout(async () => {
        const fullAnswer = getFullAnswerText();
        if (fullAnswer.trim()) {
          await submitAnswer();
        }
      }, 2000);
    }
      
    // 獲取進度
    async function fetchProgress() {
      try {
        const response = await fetch('http://localhost:5000/biography/progress', {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await response.json();
        window.currentRemaining = data.remaining ?? 0;
        window.avgAqi           = data.avg_aqi  ?? 0;
        console.log('Progress response:', data);

        if (!response.ok) {
          alert(data.error || '無法獲取進度');
          return;
        }

        /* ───────── 計算顯示用數值 ───────── */
        const pct        = (data.theme_coverage * 100).toFixed(1);          // 0–100 %
        const answered   = data.answered ?? 0;                              // 已答題數
        const remaining  = data.remaining ?? 0;                             // 未答題數
        const total      = answered + remaining;                            // 總題數
        const avgAqi     = data.avg_aqi ?? 0;                               // 0–1
        const stars      = Math.round(avgAqi * 5);                          // 0–5
        const starHTML   = Array.from({ length: 5 }, (_, i) =>
                              `<span class="star ${i < stars ? 'on' : ''}">★</span>`).join('');

        /* ───────── 組裝 HTML  ───────── */
        const html = `
          <div class="text-xl font-semibold mb-1">
            已完成 ${answered} / ${total} 題（${pct}%）
          </div>
          <div class="text-sm text-gray-600 mb-2">
            尚餘 ${remaining} 題
          </div>
          <div class="flex items-center gap-2 mb-1">
            ${starHTML}
            <span class="text-sm text-gray-700">${(avgAqi * 100).toFixed(1)} 分</span>
          </div>
          <div class="progress-bar">
            <div style="width:${pct}%;"></div>
          </div>
        `;
        document.getElementById('progress-info').innerHTML = html;

        /* ───────── 若全部完成，可提示 ───────── */
        if (remaining === 0 && total !== 0) {
          showAlert('🎉 素材蒐集完成，快來生成自傳吧！', 'success');
        }

      } catch (error) {
        console.error('Fetch progress error:', error);
        alert('錯誤：' + error.message);
      }
    }


    /* ============ 生成自傳 ============ */
    async function generateBiography() {
      // ① 先更新最新進度，確定是否達門檻
      await fetchProgress();
      //if (window.currentRemaining > 0) {
        //showAlert(`至少還要回答 ${window.currentRemaining} 題才能生成自傳喔！`, 'error');
        //return;
      //}

      // ② 組合前端表單值
      const payload = {
        style:   document.getElementById('biography-style').value,   // 風格
        lang:    document.getElementById('biography-language').value,    // 語言
        length:  document.getElementById('biography-length').value,  // 字數
        tone:    document.getElementById('biography-emotion').value,    // 情感
        usage:   document.getElementById('biography-usage').value,   // 用途
        purpose: document.getElementById('biography-aim').value  // 目的
      };

      // ③ 顯示 Loading
      showAlert('✍️ 自傳生成中，請稍候…', 'info');

      try {
        const res = await fetch('http://localhost:5000/biography/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (res.ok) {
          showAlert('🎉 自傳生成成功！', 'success');
          previewBiography(data.version_id);     // ④ 自動預覽
        } else {
          showAlert(data.error || `生成失敗 (HTTP ${res.status})`, 'error');
        }
      } catch (err) {
        console.error(err);
        showAlert('網路或伺服器錯誤，請稍後再試', 'error');
      }
    }

    /* ============ 預覽自傳 ============ */
  /* =========  預覽指定版本  ========= */
    async function previewBiography(versionId) {
      // 如果沒帶 versionId 就走最新
      if (!versionId) return previewLatestBiography();

      try {
        const res  = await fetch(`http://localhost:5000/biography/preview?id=${versionId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();

        if (!res.ok) {
          showAlert(data.error || `取得預覽失敗 (HTTP ${res.status})`, 'error');
          return;
        }

        // 1️⃣ 內嵌顯示
        document.getElementById('preview-wrapper').classList.remove('hidden');
        document.getElementById('preview-content').value = data.content || data.text || '';

        // 2️⃣ 另開視窗（可選）
        const win = window.open('', '_blank');
        if (win) {
          win.document.open();
          win.document.write(data.html || `<pre style="white-space: pre-wrap;">${(data.content || '').replace(/</g,'&lt;')}</pre>`);
          win.document.close();
        } else {
          showAlert('⚠️ 瀏覽器已封鎖彈出視窗，僅顯示內嵌預覽', 'error');
        }

      } catch (e) {
        console.error(e);
        showAlert('無法載入預覽', 'error');
      }
    }

    /* =========  預覽最新版本  ========= */
    async function previewLatestBiography() {
      try {
        const res  = await fetch('http://localhost:5000/biography/preview/latest', {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();

        if (!res.ok) {
          showAlert(data.error || `取得預覽失敗 (HTTP ${res.status})`, 'error');
          return;
        }
        document.getElementById('preview-wrapper').classList.remove('hidden');
        document.getElementById('preview-content').value = data.content || '';

      } catch (e) {
        console.error(e);
        showAlert('無法載入預覽', 'error');
      }
    }

    function renderBiographyContent(content) {
      console.log("圖片路徑：", content.match(/static\/uploads\/[^)\s]+\.(png|jpg|jpeg|gif)/g));

      // ✅ 自動補上絕對網址
      content = content.replace(/!\[.*?\]\((static\/uploads[^)]+)\)/g,
        '<br><img src="http://localhost:5000/$1" alt="圖片" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 5px;"><br>');

      // ✅ 處理換行
      content = content.replace(/\n/g, '<br>');

      return content;
    }

    function renderStars(avgAqi) {
      const stars = Math.round(avgAqi * 5); // 0~5
      let html = '';
      for (let i = 1; i <= 5; i++) {
        html += `<span class="star ${i <= stars ? 'on' : ''}">★</span>`;
      }
      return html;
    }
    async function fetchPlans() {
      console.log('Fetching plans');
      try {
        const response = await fetch('http://localhost:5000/plans/plans', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        console.log('Plans response:', data);
        if (response.ok) {
          const planList = document.getElementById('plan-list');
          const planSelect = document.getElementById('plan-id');
          planList.innerHTML = '';
          planSelect.innerHTML = '';
          data.plans.forEach(plan => {
            planList.innerHTML += `<p>${plan.name} (字數限制：${plan.word_limit || '無限制'})</p>`;
            const option = document.createElement('option');
            option.value = plan.id;
            option.textContent = plan.name;
            planSelect.appendChild(option);
          });
        } else {
          alert(data.error || '無法獲取計劃');
        }
      } catch (error) {
        console.error('Fetch plans error:', error);
        alert('錯誤：' + error.message);
      }
    }

    // 選擇計劃
    async function selectPlan() {
      const planId = document.getElementById('plan-id').value;

      console.log('Selecting plan:', { planId });
      try {
        const response = await fetch('http://localhost:5000/plans/select-plan', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ plan_id: parseInt(planId) })
        });
        const data = await response.json();
        console.log('Select plan response:', data);
        if (response.ok) {
          alert('計劃選擇成功！');
          fetchPlans();
        } else {
          alert(data.error || '選擇計劃失敗');
        }
      } catch (error) {
        console.error('Select plan error:', error);
        alert('錯誤：' + error.message);
      }
    }
  </script>
</body>
</html>