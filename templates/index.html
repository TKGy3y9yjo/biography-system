<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„ç”Ÿå‘½æ•…äº‹</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 6px;
    }
    .progress-bar > div {
      height: 100%;
      background: linear-gradient(to right, #60a5fa, #6366f1);
    }
    .star {
      font-size: 20px;
      color: #e5e7eb;
    }
    .star.on {
      color: #fbbf24;
    }
    #preview-content img {
      max-width: 100%;
      height: auto;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .title-glow {
      text-shadow: 0 0 20px rgba(219, 39, 119, 0.3);
    }

    .subtitle-fade {
      opacity: 0.8;
      transition: opacity 0.3s ease;
    }
    body {
      font-family: 'Noto Sans TC', sans-serif;
    }
    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(40px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-fadeInUp {
      animation: fadeInUp 0.8s ease-out;
    }
    /* åœ¨ style æ¨™ç±¤ä¸­åŠ å…¥ */
    @keyframes slideInFromLeft {
      0% { opacity: 0; transform: translateX(-50px); }
      100% { opacity: 1; transform: translateX(0); }
    }

    .animate-slideIn { animation: slideInFromLeft 0.6s ease-out; }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .animate-float { animation: float 3s ease-in-out infinite; }
  </style>
</head>
<body class="bg-gradient-to-r from-pink-100 via-orange-100 to-yellow-100 min-h-screen">
  <!-- Header -->
  <div id="cover-section" class="flex flex-col justify-center items-center h-screen bg-gradient-to-r from-pink-100 via-orange-100 to-yellow-100 text-center px-4 overflow-auto">
    
    <!-- æ’åœ–èˆ‡æ¨™é¡Œ -->
    <img src="/static/img/cover.png" class="w-60 mb-6 animate-float animate-fadeInUp" alt="å°é¢æ’åœ–">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">æˆ‘çš„äººç”Ÿæ•…äº‹</h1>
    <p class="text-gray-600 text-lg mb-6">æ¯ä¸€æ®µç¶“æ­·ï¼Œéƒ½æ˜¯å€¼å¾—è¨´èªªçš„ç¯‡ç« </p>

    <!-- CTA æŒ‰éˆ• -->
    <button onclick="showLoginSection()" class="px-8 py-4 bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 font-medium">
      âœ¨ é–‹å§‹æ›¸å¯«æˆ‘çš„æ•…äº‹
    </button>

    <!-- åŠŸèƒ½é è¦½å¡ç‰‡å€å¡Š -->
    <div id="feature-preview" class="mt-10 grid grid-cols-1 md:grid-cols-3 gap-6 px-10">
      <div class="bg-white shadow-xl rounded-2xl p-6 text-left hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 border border-pink-100">
        <!-- å°‡æ¯å€‹å¡ç‰‡çš„æ¨™é¡Œæ”¹ç‚º -->
        <h3 class="text-lg font-semibold mb-2 flex items-center">
          <span class="text-2xl mr-2 bg-gradient-to-r from-pink-400 to-orange-400 bg-clip-text text-transparent">ğŸ“Š</span>
          å‰µä½œé€²åº¦
        </h3>
        <p class="text-gray-600 text-sm">éš¨æ™‚æŸ¥çœ‹ç­”é¡Œæ•¸é‡èˆ‡é€²åº¦å®Œæˆç‡ï¼Œè¿½è¹¤ä½ çš„äººç”Ÿæ•…äº‹ã€‚</p>
      </div>
      <div class="bg-white shadow-lg rounded-xl p-6 text-left hover:shadow-xl transition">
        <h3 class="text-lg font-semibold mb-2 flex items-center">
          <span class="text-2xl mr-2 bg-gradient-to-r from-pink-400 to-orange-400 bg-clip-text text-transparent">ğŸ“</span>
          è‡ªå‚³ç”Ÿæˆ
        </h3>
        <p class="text-gray-600 text-sm">é¸æ“‡é¢¨æ ¼èˆ‡ç”¨é€”ï¼Œç«‹å³è½‰æ›ä½ çš„ç­”è¦†ç‚ºå‹•äººè‡ªå‚³ã€‚</p>
      </div>
      <div class="bg-white shadow-lg rounded-xl p-6 text-left hover:shadow-xl transition">
        <h3 class="text-lg font-semibold mb-2 flex items-center">
          <span class="text-2xl mr-2 bg-gradient-to-r from-pink-400 to-orange-400 bg-clip-text text-transparent">ğŸ“‚</span>
          æ­·å²ç´€éŒ„
        </h3>
        <p class="text-gray-600 text-sm">ä¿å­˜ä¸¦é è¦½éå»ç”Ÿæˆçš„æ‰€æœ‰ç‰ˆæœ¬ï¼Œæ–¹ä¾¿ç®¡ç†èˆ‡æ¯”å°ã€‚</p>
      </div>
    </div> 

    <!-- ç†å¿µä»‹ç´¹ -->
    <div class="mt-20 bg-white/60 backdrop-blur-sm rounded-2xl p-8 shadow-lg border border-white/20">
      <h2 class="text-3xl font-bold mb-6 bg-gradient-to-r from-pink-600 via-orange-500 to-yellow-500 bg-clip-text text-transparent"></h2>
      <p class="text-lg leading-relaxed text-gray-700">
        æ¯å€‹äººéƒ½æœ‰å±¬æ–¼è‡ªå·±çš„æ•…äº‹ï¼Œåªæ˜¯å¾ä¾†æ²’æœ‰æ©Ÿæœƒè¢«å¥½å¥½èªªå‡ºä¾†ã€‚<br/>
        <span class="text-pink-600 font-medium">YouSayWrite</span> å¹«åŠ©ä½ é€éç°¡å–®çš„æå•èˆ‡å¼•å°ï¼Œå°‡è¨˜æ†¶åŒ–ç‚ºæ–‡å­—ã€å°‡ç¶“æ­·å¯«æˆè‡ªå‚³ã€‚<br/>
        ç„¡è«–æ˜¯ç‚ºäº†è‡ªå·±ã€å®¶äººã€æˆ–æœªä¾†çš„æŸä¸€å¤©ï¼Œæˆ‘å€‘éƒ½ç›¸ä¿¡ï¼š<br/>
        <em>ã€Œè¨˜éŒ„ï¼Œå°±æ˜¯å°Šé‡èˆ‡ä¿å­˜ã€‚ã€</em>
      </p>
    </div>

  </div>
</body>

  <!-- Loading Overlay & Alert -->
  <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center hidden z-50">
    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-solid"></div>
  </div>
  <div id="alert-box" class="fixed top-5 right-5 hidden p-4 mb-4 text-sm rounded-lg shadow-lg z-50" role="alert"></div>

  <!-- Auth Section -->
<div id="auth-section" class="hidden flex justify-center items-center min-h-screen bg-gradient-to-r from-pink-100 via-orange-100 to-yellow-100">
    <div id="login-form" class="bg-white p-6 rounded-2xl shadow-lg ring-1 ring-gray-100 w-full max-w-md">
      <h2 class="text-2xl font-semibold mb-4">ç™»å…¥</h2>
      <div class="relative mb-2">
        <input id="login-email" type="email" placeholder="é›»å­éƒµä»¶" class="w-full p-2 pl-10 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
        <span class="absolute left-3 top-2.5 text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12H8m0 0l4 4m-4-4l4-4" />
          </svg>
        </span>
      </div>
      <input id="login-password" type="password" placeholder="å¯†ç¢¼" class="w-full p-2 mb-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
      <button onclick="login()" class="bg-blue-500 hover:bg-blue-600 transition duration-300 text-white p-2 rounded w-full">ç™»å…¥</button>
      <p class="mt-2 text-center text-sm text-gray-600">
        æ²’æœ‰å¸³è™Ÿï¼Ÿ<a href="#" onclick="showRegister()" class="text-blue-500 hover:underline">è¨»å†Š</a>
      </p>
    </div>
    <!-- è¨»å†Šè¡¨å–® -->
    <div id="register-form" class="hidden bg-white p-6 rounded-2xl shadow-lg ring-1 ring-gray-100 max-w-md w-full mx-auto mt-4">
      <h2 class="text-2xl font-semibold mb-4">è¨»å†Š</h2>
      <input id="register-email" type="email" placeholder="é›»å­éƒµä»¶" class="w-full p-2 mb-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
      <input id="register-password" type="password" placeholder="å¯†ç¢¼" class="w-full p-2 mb-4 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
      <button onclick="register()" class="bg-blue-500 hover:bg-blue-600 transition duration-300 text-white p-2 rounded w-full">è¨»å†Š</button>
      <p class="mt-2 text-center text-sm text-gray-600">
        å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿ<a href="#" onclick="showLogin()" class="text-blue-500 hover:underline">ç™»å…¥</a>
      </p>
    </div>
  </div>

  <div id="main-section" class="hidden min-h-screen">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <div class="w-64 bg-white shadow-lg p-4 space-y-4 min-h-screen">
        <div class="flex items-center mb-6 p-4 bg-gradient-to-br from-orange-100 via-pink-100 to-rose-100 rounded-2xl shadow-inner">
          <div class="w-12 h-12 bg-gradient-to-r from-orange-400 to-pink-400 rounded-full flex items-center justify-center text-white text-xl">
            ğŸ‘¤
          </div>
          <div class="ml-3">
            <p class="font-medium text-gray-800">æ­¡è¿å›ä¾†</p>
            <p class="text-sm text-gray-600">é–‹å§‹æ›¸å¯«ä½ çš„æ•…äº‹</p>
          </div>
        </div>
        <h2 class="text-xl font-semibold mb-2">åŠŸèƒ½é¸å–®</h2>
        <button onclick="showSection('progress')" class="w-full text-left p-2 rounded hover:bg-blue-100">ğŸ“Š é€²åº¦</button>
        <button onclick="showSection('biography')" class="w-full text-left p-2 rounded hover:bg-blue-100">ğŸ“ ç”Ÿæˆè‡ªå‚³</button>
        <button onclick="showSection('plans')" class="w-full text-left p-2 rounded hover:bg-blue-100">ğŸ“Œ é¸æ“‡è¨ˆç•«</button>
        <button onclick="showSection('history')" class="w-full text-left p-2 rounded hover:bg-blue-100">ğŸ“‚ è‡ªå‚³ç´€éŒ„</button>
        <button onclick="logout()" class="w-full text-left p-2 mt-4 bg-red-500 hover:bg-red-600 text-white rounded">ç™»å‡º</button>
      </div>

      <!-- ä¸»åŠŸèƒ½å€ -->
      <div class="flex-1 p-6 space-y-6 bg-gray-50 overflow-auto">
        <!-- é€²åº¦å€ -->
        <div id="history-section" class="hidden bg-white p-6 rounded shadow-md">
          <h2 class="text-xl font-bold mb-4">ğŸ“‚è‡ªå‚³ç´€éŒ„</h2>
          <div id="biography-history-list" class="space-y-4 text-sm text-gray-700">å°šæœªè¼‰å…¥</div>
        </div>

        <!-- æ›¿æ›é€²åº¦ä¿¡æ¯é¡¯ç¤º -->
  <div id="progress-section" class="hidden bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-xl shadow-lg">
    â€¦
    <div class="bg-white p-4 rounded-lg shadow-sm">
        <div id="progress-info" class="my-4 p-4 rounded-xl shadow bg-white/60"></div>
    </div>
    <p class="text-center text-xs text-gray-500 mt-2">æŒçºŒå‰µä½œï¼Œæ•…äº‹æœƒæ›´ç²¾å½©ï¼</p>

    <!-- â­ æŒ‰éˆ•æ”¾é€™è£¡ -->
    <button
        onclick="loadQuestionSection()"
        class="mt-4 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600
              text-white p-2 rounded-lg w-full transition-all duration-200 transform hover:scale-105">
        âœ¨ ç¹¼çºŒå›ç­”å•é¡Œ
    </button>
  </div>

        <!-- å•é¡Œèˆ‡å›ç­”å€ -->
        <div id="question-section" class="bg-gradient-to-br from-pink-50 to-orange-50 p-6 rounded-2xl shadow-lg border border-pink-100 space-y-4">
          <div class="flex items-center mb-4">
            <span class="text-3xl mr-3">ğŸ’­</span>
            <div>
              <h2 class="text-xl font-semibold text-gray-800">è®“æˆ‘å€‘èŠèŠä½ çš„æ•…äº‹</h2>
              <p class="text-sm text-gray-600">æ¯å€‹å›ç­”éƒ½æ˜¯çè²´çš„å›æ†¶ç‰‡æ®µ</p>
            </div>
          </div>
            <div class="bg-white/80 backdrop-blur-sm p-4 rounded-xl border border-pink-100 shadow-sm">
              <p id="current-question" class="text-gray-800 font-medium text-lg leading-relaxed"></p>
            </div>
            <input id="question-id" type="hidden">

          <!-- ğŸ™ï¸ éŒ„éŸ³æŒ‰éˆ•æ”¾è¼¸å…¥æ¡†ä¸Šæ–¹ -->
          <div id="record-controls" class="mb-2">
            <button id="start-record" onclick="startRecording()" class="bg-gradient-to-r from-purple-400 to-pink-400 hover:from-purple-500 hover:to-pink-500 text-white p-3 rounded-xl w-full transition-all duration-300 transform hover:scale-105 shadow-md">ğŸ™ï¸ é–‹å§‹éŒ„éŸ³</button>
            <button id="stop-record" onclick="stopRecordingAndUpload()" class="bg-gradient-to-r from-red-400 to-rose-400 hover:from-red-500 hover:to-rose-500 text-white p-3 rounded-xl w-full hidden transition-all duration-300 transform hover:scale-105 shadow-md">â¹ï¸ åœæ­¢éŒ„éŸ³ä¸¦ä¸Šå‚³</button>
          </div>
          <!-- è¼¸å…¥æ¡† -->
          <!-- å›ç­”æ®µè½å®¹å™¨ -->
          <div id="answer-paragraphs" class="space-y-2 max-h-40 overflow-y-auto text-gray-700 font-medium"></div>
          <textarea id="answer-content" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„å›ç­”..." class="w-full p-4 border-2 border-pink-200 rounded-xl focus:border-pink-400 focus:ring-2 focus:ring-pink-200 focus:outline-none resize-none h-32 bg-white/80 backdrop-blur-sm"></textarea>

          <!-- æäº¤èˆ‡æ¸…ç©ºï¼šä¸¦æ’ -->
          <div class="flex space-x-3">
            <button onclick="submitAnswer()" class="flex-1 bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 text-white p-3 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-md font-medium">âœ¨ å®Œæˆå›ç­”</button>
            <button onclick="clearAnswer()" class="bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 text-gray-700 p-3 rounded-xl transition-all duration-300 hover:shadow-md">ğŸ—‘ï¸ æ¸…ç©º</button>
          </div>
          <button onclick="rezeroAnswer()" class=" bg-gradient-to-r from-red-300 to-pink-250 hover:from-red-300 hover:to-pink-200 text-white p-3 rounded-xl w-full transition-all duration-300 transform hover:scale-105 shadow-md font-medium">é‡ç½®å›ç­”</button>

          <div class="mb-2">
            <label class="block mb-2">æˆ–ä¸Šå‚³éŸ³è¨Šå›ç­”</label>
            <input id="audio-file" type="file" accept="audio/*" class="w-full p-2 border rounded mb-2">
          </div>
          <button onclick="transcribeAnswer()" class="hidden bg-gradient-to-r from-green-400 to-emerald-500...">ğŸµ æäº¤éŸ³è¨Šå›ç­”</button>
          
          <button onclick="fetchNextQuestion()" class="hidden bg-gray-500 text-white...">ç²å–ä¸‹ä¸€å€‹å•é¡Œ</button>

        </div>
        <div id="image-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
          <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-xl">
            <h3 class="text-lg font-bold mb-4 text-gray-800">ğŸ“· æ˜¯å¦æƒ³ç‚ºé€™æ®µå›ç­”ä¸Šå‚³ä¸€å¼µåœ–ç‰‡ï¼Ÿ</h3>
            <input id="image-file" type="file" accept="image/*" class="w-full mb-4 border p-2 rounded" />
            <div class="flex justify-end space-x-3">
              <button onclick="cancelImageUpload()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-gray-800">ç•¥é</button>
              <button onclick="uploadAnswerImage()" class="px-4 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded">ä¸Šå‚³åœ–ç‰‡</button>
            </div>
        </div>
        </div>
        <!-- è‡ªå‚³ç”Ÿæˆèˆ‡é è¦½å€ -->
        <div id="biography-section" class="hidden bg-white p-6 rounded shadow-md">
          <h2 class="text-xl font-bold mb-4">ç”Ÿæˆè‡ªå‚³</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block mb-1 font-medium">é¢¨æ ¼</label>
              <select id="biography-style" class="w-full p-2 border rounded">
                <option value="è‡ªç„¶">è‡ªç„¶</option>
                <option value="æ­£å¼">æ­£å¼</option>
                <option value="æ–‡è—">æ–‡è—</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 font-medium">èªè¨€</label>
              <select id="biography-language" class="w-full p-2 border rounded">
                <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                <option value="English">è‹±æ–‡</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 font-medium">å­—æ•¸</label>
              <select id="biography-length" class="w-full p-2 border rounded">
                <option value="300 å­—">300 å­—</option>
                <option value="500 å­—">500 å­—</option>
                <option value="800 å­—">800 å­—</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 font-medium">ç”¨é€”</label>
              <select id="biography-usage" class="w-full p-2 border rounded">
                <option value="å€‹äººç´€éŒ„">å€‹äººç´€éŒ„</option>
                <option value="æ±‚è·">æ±‚è·</option>
                <option value="ç”³è«‹å­¸æ ¡">ç”³è«‹å­¸æ ¡</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 font-medium">æƒ…æ„Ÿ</label>
              <select id="biography-emotion" class="w-full p-2 border rounded">
                <option value="ç©æ¥µ">ç©æ¥µ</option>
                <option value="æ„Ÿæ€§">æ„Ÿæ€§</option>
                <option value="å‹µå¿—">å‹µå¿—</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 font-medium">ç›®çš„</label>
              <select id="biography-aim" class="w-full p-2 border rounded">
                <option value="å±•ç¤ºå€‹äººæˆé•·">å±•ç¤ºå€‹äººæˆé•·</option>
                <option value="ç”³è«‹å­¸æ ¡">ç”³è«‹å­¸æ ¡</option>
                <option value="åˆ†äº«è·æ¥­æ­·ç¨‹">åˆ†äº«è·æ¥­æ­·ç¨‹</option>
              </select>
            </div>
          </div>
          <button onclick="generateBiography()" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded w-full mb-2">ç”Ÿæˆè‡ªå‚³</button>
          <button onclick="previewLatestBiography()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded w-full">é è¦½è‡ªå‚³</button>
          <div id="loading-message" class="hidden mt-2 text-center text-gray-600">âœï¸ è‡ªå‚³ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...</div>
          <div id="preview-wrapper" class="hidden mt-4">
            <textarea id="preview-content" class="w-full h-64 p-4 border rounded resize-none" readonly></textarea>
        </div>

        <!-- è¨ˆåŠƒé¸æ“‡å€ -->
        <div id="plans-section" class="hidden bg-white p-6 rounded shadow-md">
          <h2 class="text-xl font-bold mb-4">è¨ˆç•«é¸æ“‡</h2>
          <div id="plan-list" class="mb-4 text-sm text-gray-600">å°šæœªè¼‰å…¥è¨ˆç•«åˆ—è¡¨</div>
          <select id="plan-id" class="w-full p-2 border rounded mb-2"></select>
          <button onclick="selectPlan()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded w-full">é¸æ“‡è¨ˆç•«</button>
        </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('main-section').classList.add('hidden');
      document.getElementById('cover-section').classList.remove('hidden');
    });
    function showLoginSection() {
      document.getElementById('cover-section').classList.add('hidden');
      document.getElementById('auth-section').classList.remove('hidden');
      document.getElementById('feature-preview').classList.remove('hidden');
    }


    let token = null;
    // æª¢æŸ¥éº¥å…‹é¢¨æ¬Šé™
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(() => {
        document.getElementById('start-record').disabled = false;
      })
      .catch((error) => {
        console.error('éº¥å…‹é¢¨æ¬Šé™éŒ¯èª¤:', error);
        document.getElementById('start-record').disabled = true;
        document.getElementById('start-record').textContent = 'éŒ„éŸ³ä¸å¯ç”¨ï¼ˆç„¡éº¥å…‹é¢¨æ¬Šé™ï¼‰';
      });
    // åˆ‡æ›åˆ°è¨»å†Šè¡¨å–®
    function showRegister() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.remove('hidden');
    }
    function clearAnswer() {
    document.getElementById('answer-content').value = '';
    }
    // åˆ‡æ›åˆ°ç™»å…¥è¡¨å–®
    function showLogin() {
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
    }
    function showAlert(message, type = 'success') {
      const box = document.getElementById('alert-box');
      box.textContent = message;
      box.className = `fixed top-5 right-5 p-4 mb-4 text-sm rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
      }`;
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 3000);
    }

    function showLoading(show = true) {
      document.getElementById('loading-overlay').classList.toggle('hidden', !show);
    }

    function insertParagraph(text) {
      const container = document.getElementById('answer-paragraphs');
      const p = document.createElement('div');
      p.className = 'flex justify-between items-center bg-gradient-to-r from-pink-50 to-orange-50 p-3 rounded-xl shadow-sm border border-pink-200 animate-fadeInUp';
      p.innerHTML = `
        <span class="text-gray-800 flex-1">${text}</span>
        <button onclick="this.parentElement.remove()" class="ml-2 text-red-500 hover:text-red-700">âŒ</button>
      `;
      container.appendChild(p);
    }
    async function fetchBiographyHistory() {
      try {
        const response = await fetch("http://localhost:5000/biography/versions", {
          headers: { Authorization: "Bearer " + token }
        });
        const data = await response.json();
        const list = document.getElementById("biography-history-list");
        console.log("ğŸ“¦ versions:", data.versions);
        if (response.ok) {
          list.innerHTML = data.versions.map(b => `
            <div class="p-3 border rounded shadow-sm">
              <input id="title-${b.id}" value="${b.title || 'æœªè¨­å®šæ¨™é¡Œ'}" 
                    class="font-medium w-full border-b mb-2" 
                    onchange="saveBiographyTitle(${b.id})">
              <p class="text-xs text-gray-500">
                é¢¨æ ¼ï¼š${b.style || 'æœªçŸ¥'}ã€€èªè¨€ï¼š${b.language || 'æœªçŸ¥'}ã€€æ™‚é–“ï¼š${new Date(b.created_at).toLocaleString('zh-TW', { hour12: false })}
              </p>
              <button onclick="toggleBiography(this, ${b.id})">æŸ¥çœ‹å…¨æ–‡</button>
              <div id="export-content-${b.id}" class="hidden overflow-hidden max-h-0 p-4 border rounded bg-white text-gray-800"></div>
            </div>
          `).join('');
        } else {
          list.innerHTML = `<p class="text-red-500">${data.error}</p>`;
        } 
      } catch (e) {
        console.error("è¼‰å…¥å¤±æ•—", e);
      }
    }

    const biographyLoaded = {};      // è¨˜éŒ„å·²è¼‰å…¥ id
    const biographyExpanded = {};    // è¨˜éŒ„å±•é–‹ç‹€æ…‹

    async function toggleBiography(button, id) {
      function renderBiographyContent(content) {
      content = content.replace(/!\[.*?\]\((static\/uploads[^)]+)\)/g,
        '<br><img src="http://localhost:5000/$1" alt="åœ–ç‰‡" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 5px;"><br>');
      content = content.replace(/\n/g, '<br>');
      return content;
      }
      const container = document.getElementById(`export-content-${id}`);
      container.style.overflow = 'hidden';
      if (!biographyLoaded[id]) {
        try {
          const res = await fetch(`http://localhost:5000/biography/export/${id}?format=txt`, {
            headers: { Authorization: "Bearer " + token }
          });
          const text = await res.text();
          const rendered = renderBiographyContent(text);

          container.innerHTML = rendered;
          container.classList.remove("hidden", "max-h-0");

          container.classList.add("max-h-[1000px]");

          button.textContent = "æ”¶åˆå…§å®¹";
          biographyLoaded[id] = true;
          biographyExpanded[id] = true;
        } catch (e) {
          console.error("è¼‰å…¥å¤±æ•—", e);
          alert("è¼‰å…¥è‡ªå‚³å¤±æ•—");
        }
      } else {
        if (biographyExpanded[id]) {
          container.style.display = 'none'; 
          button.textContent = "æŸ¥çœ‹å…¨æ–‡";
          biographyExpanded[id] = false;
        } else {
          container.style.display = 'block';
          button.textContent = "æ”¶åˆå…§å®¹";
          biographyExpanded[id] = true;
        }
      }
    }


    // è¨»å†Š
    async function register() {
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;

      if (!email || !password) {
        alert('è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼');
        return;
      }

      console.log('Sending register request:', { email, password });
      try {
        const response = await fetch('http://localhost:5000/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await response.json();
        console.log('Register response:', data);
        if (response.ok) {
          alert('è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥ï¼');
          showLogin();
        } else {
          alert(data.error || 'è¨»å†Šå¤±æ•—');
        }
      } catch (error) {
        console.error('Register error:', error);
        alert('éŒ¯èª¤ï¼š' + error.message);
      }
    }

    // ç™»å…¥
    async function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      if (!email || !password) {
        alert('è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼');
        return;
      }

      console.log('Sending login request:', { email });
      try {
        const response = await fetch('http://localhost:5000/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await response.json();
        console.log('Login response:', data);
        if (response.ok) {
          token = data.token;
          localStorage.setItem("token", data.token);
          showAlert("ç™»å…¥æˆåŠŸï¼");
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('main-section').classList.remove('hidden');
          showSection('progress');  // æ–°å¢é€™è¡Œï¼Œç›´æ¥é¡¯ç¤ºé€²åº¦ç•«é¢
          fetchProgress();
          fetchPlans();
          fetchNextQuestion();
        } else {
          alert(data.error || 'ç™»å…¥å¤±æ•—');
        }
      } catch (error) {
        console.error('Login error:', error);
        alert('éŒ¯èª¤ï¼š' + error.message);
      }
    }

    // ç™»å‡º
    async function loadBiographyHistory() {
      const token = localStorage.getItem("token");
      const res = await fetch("http://localhost:5000/biography/versions", {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await res.json();

      const container = document.getElementById("biography-list");
      container.innerHTML = "";

      if (data.versions) {
        const versions = data.versions;
        data.versions.forEach(entry => {
          const div = document.createElement("div");
          div.className = "p-4 border rounded shadow-sm";

          const titleInput = document.createElement("input");
          titleInput.value = entry.title || "æœªå‘½åè‡ªå‚³";
          titleInput.id = `title-${b.id}`;
          titleInput.className = "text-lg font-semibold w-full border-b mb-2";
          titleInput.onchange = () => updateBiographyTitle(entry.id, titleInput.value);
          alert("âœ… å·²æ›´æ–°æ¨™é¡Œï¼");

          const contentPreview = document.createElement("p");
          contentPreview.textContent = `é¢¨æ ¼: ${entry.style}, èªè¨€: ${entry.language}, æ™‚é–“: ${date}`;
          contentPreview.className = "text-sm text-gray-600";

          div.appendChild(titleInput);
          div.appendChild(contentPreview);
          container.appendChild(div);
        });
      } else {
        container.innerHTML = "<p class='text-gray-600'>å°šæœªç”Ÿæˆä»»ä½•è‡ªå‚³</p>";
      }
    }

    async function updateBiographyTitle(biographyId, newTitle) {
      const token = localStorage.getItem("token");
      await fetch("http://localhost:5000/biography/edit", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ biography_id: biographyId, title: newTitle })
      });
      const data = await res.json();
      if (!res.ok) {
        alert("âŒ ä¿®æ”¹å¤±æ•—ï¼š" + data.error);
      }
    }
    function showSection(section) {
      ['progress', 'biography', 'plans','history'].forEach(id => {
        document.getElementById(`${id}-section`).classList.add('hidden');
      });
      document.getElementById('question-section').classList.add('hidden');
      document.getElementById(`${section}-section`).classList.remove('hidden');
      if (section === 'history') fetchBiographyHistory();
    }
    function loadQuestionSection() {
      showSection('progress');
      document.getElementById('question-section').classList.remove('hidden');
    }
    function logout() {
      console.log('Logging out');
      token = null;
      document.getElementById('auth-section').classList.remove('hidden');
      document.getElementById('main-section').classList.add('hidden');
      document.getElementById('login-email').value = '';
      document.getElementById('login-password').value = '';
      document.getElementById('plan-list').innerHTML = '';
    }

    // ç²å–ä¸‹ä¸€å€‹å•é¡Œ
    async function fetchNextQuestion() {
      console.log('Fetching next question');
      try {
        const response = await fetch('http://localhost:5000/biography/next-question', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        console.log('Next question response:', data);
        if (response.ok) {
          if (data.question) {
            document.getElementById('current-question').textContent = `å•é¡Œï¼ˆ${data.question.theme}ï¼‰ï¼š${data.question.content}`;
            document.getElementById('question-id').value = data.question.id;
            document.getElementById('answer-paragraphs').innerHTML = '';
          } else {
            document.getElementById('current-question').textContent = 'ğŸ‰ æ‰€æœ‰å•é¡Œå·²å®Œæˆï¼ç¾åœ¨å¯ä»¥ç”Ÿæˆè‡ªå‚³äº†';
            document.getElementById('question-id').value = '';
            showSection('biography');
          }
        } else {
          alert(data.error || 'ç„¡æ³•ç²å–å•é¡Œ');
        }
      } catch (error) {
        console.error('Fetch next question error:', error);
        alert('éŒ¯èª¤ï¼š' + error.message);
      }
    }
    async function saveBiographyTitle(id) {
      const title = document.getElementById(`title-${id}`).value.trim();
      try {
        const res = await fetch("http://localhost:5000/biography/edit", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify({ biography_id: id, title: title || null })
        });
        const data = await res.json();
        if (res.ok) {
          alert("âœ… åç¨±å·²å„²å­˜ï¼");
        } else {
          alert("âŒ å„²å­˜å¤±æ•—ï¼š" + data.error);
        }
      } catch (e) {
        alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
      }
    }

    // æäº¤å›ç­”
     async function submitAnswer() {
      const questionId = document.getElementById('question-id').value;
      const answer = getFullAnswerText();

      if (!questionId || !answer) {
        alert('å•é¡Œ ID æˆ–å›ç­”å…§å®¹ä¸èƒ½ç‚ºç©º');
        return;
      }

      try {
        const response = await fetch('http://localhost:5000/biography/answer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ question_id: parseInt(questionId), answer })
        });
        const data = await response.json();
        if (response.ok) {
          document.getElementById('answer-content').value = '';
          const aqi = data.aqi ?? 0;
          showAlert(`âœ… å·²æäº¤ï¼æœ¬æ¬¡ AQIï¼š${(aqi * 100).toFixed(1)} åˆ†`, 'success');
          document.getElementById('image-upload-modal').classList.remove('hidden');
          sessionStorage.setItem('lastQuestionId', questionId);
          await fetchProgress();
        } else {
          alert(data.error || 'æäº¤å›ç­”å¤±æ•—');
        } 
      } catch (error) {
        console.error('Submit answer error:', error);
        alert('éŒ¯èª¤ï¼š' + error.message);
      }
    }
    async function transcribeAnswer() {
      const questionId = document.getElementById('question-id').value;
      const audioFile = document.getElementById('audio-file').files[0];

      if (!questionId) {
        alert('è«‹å…ˆç²å–ä¸€å€‹å•é¡Œ');
        return;
      }
      if (!audioFile) {
        alert('è«‹é¸æ“‡éŸ³è¨Šæª”æ¡ˆ');
        return;
      }

      const formData = new FormData();
      formData.append('file', audioFile);
      formData.append('question_id', questionId);

      try {
        const response = await fetch('http://localhost:5000/biography/transcribe', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        const data = await response.json();
        console.log('éŸ³è¨Šå›ç­”å›æ‡‰:', data);
        if (response.ok) {
          alert(`éŸ³è¨Šå›ç­”å·²å„²å­˜ï¼š${data.transcription}`);
          if (data.question) {
            document.getElementById('current-question').textContent = data.question.content;
            document.getElementById('question-id').value = data.question.id;
            document.getElementById('audio-file').value = ''; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥
          } else {
            document.getElementById('current-question').textContent = 'æ‰€æœ‰å•é¡Œå·²å®Œæˆï¼Œå¯ç”Ÿæˆè‡ªå‚³';
            document.getElementById('question-id').value = '';
          }
        } else {
          alert(data.error || 'æäº¤éŸ³è¨Šå›ç­”å¤±æ•—');
        }
      } catch (error) {
        console.error('éŸ³è¨Šå›ç­”éŒ¯èª¤:', error);
        alert('éŒ¯èª¤ï¼š' + error.message);
      }
    }
    function cancelImageUpload() {
      document.getElementById('image-upload-modal').classList.add('hidden');
      fetchNextQuestion();
    }
    async function uploadAnswerImage() {
      const file = document.getElementById('image-file').files[0];
      const questionId = sessionStorage.getItem('lastQuestionId');

      if (!file || !questionId) {
        alert('è«‹é¸æ“‡åœ–ç‰‡');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('question_id', questionId);

      try {
        const response = await fetch('http://localhost:5000/biography/answer/image', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error('ä¼ºæœå™¨å›å‚³é JSONï¼š\n' + text);
        }

        const data = await response.json();
        if (response.ok) {
          showAlert('âœ… åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼');
          document.getElementById('image-upload-modal').classList.add('hidden');
          fetchNextQuestion();
        } else {
          alert(data.error || 'åœ–ç‰‡ä¸Šå‚³å¤±æ•—');
        }
      } catch (e) {
        alert('ä¸Šå‚³éŒ¯èª¤ï¼š' + e.message);
      }
    }
    // é‡æ–°é–‹å§‹å•ç­”
    async function rezeroAnswer() {
      if (!confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å•ç­”ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰å•é¡Œå’Œå›ç­”è¨˜éŒ„ï¼')) {
        return;
      }

      console.log('Resetting questions and answers');
      try {
        const response = await fetch('http://localhost:5000/biography/reset', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();
        console.log('Reset response:', data);
        if (response.ok) {
          alert('å•ç­”å·²é‡ç½®ï¼');
          document.getElementById('current-question').textContent = '';
          document.getElementById('question-id').value = '';
          document.getElementById('answer-content').value = '';
          fetchNextQuestion();
          fetchProgress();
        } else {
          alert(data.error || 'é‡ç½®å¤±æ•—');
        }
      } catch (error) {
        console.error('Reset error:', error);
        alert('éŒ¯èª¤ï¼š' + error.message);
      }
    }
    
    let mediaRecorder = null;
    let audioChunks = [];
    let currentStream = null;

    async function startRecording() {
      const questionId = document.getElementById('question-id').value;
      if (!questionId) {
        alert('è«‹å…ˆç²å–ä¸€å€‹å•é¡Œ');
        return;
      }

        try {
          currentStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(currentStream);
                // è¨­å®šéŒ„éŸ³æ ¼å¼ç‚º WAV æˆ– MP3
          const options = { mimeType: 'audio/webm;codecs=opus' };
          if (!MediaRecorder.isTypeSupported(options.mimeType)) {
            options.mimeType = 'audio/webm';
          }
          mediaRecorder = new MediaRecorder(currentStream, options);

          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              audioChunks.push(event.data);
            }
          };

          // æ–°å¢ï¼šå³æ™‚è½‰æ›è™•ç†
          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            await transcribeToTextArea(audioBlob);  // æ–°å¢çš„å‡½æ•¸
            audioChunks = [];
          };

          mediaRecorder.start();
          document.getElementById('start-record').classList.add('hidden');
          document.getElementById('stop-record').classList.remove('hidden');
        } catch (error) {
          console.error('éŒ„éŸ³éŒ¯èª¤:', error);
          alert('ç„¡æ³•é–‹å§‹éŒ„éŸ³ï¼šè«‹æª¢æŸ¥éº¥å…‹é¢¨æ¬Šé™');
        }
      }
      // æ–°å¢é€™å€‹å‡½æ•¸ï¼Œç”¨æ–¼å³æ™‚è½‰æ›ä¸¦é¡¯ç¤ºåœ¨æ–‡å­—æ¡†
    async function transcribeToTextArea(audioBlob) {
      const formData = new FormData();
      formData.append('file', audioBlob, 'recording.webm');
      
      try {
        const response = await fetch('http://localhost:5000/biography/transcribe-only', {
          method: 'POST',
          headers: {
            Authorization: 'Bearer ' + localStorage.getItem('token')
          },
          body: formData
        });

        const data = await response.json();
        console.log('è½‰éŒ„å›æ‡‰:', data); // åŠ ä¸Šé€™è¡Œä¾†çœ‹è©³ç´°éŒ¯èª¤
        
        if (data.transcription) {
          insertParagraph(data.transcription);
        } else {
          console.error('è½‰éŒ„å¤±æ•—:', data); // åŠ ä¸Šé€™è¡Œ
          showAlert('èªéŸ³è½‰æ›å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
        }
      } catch (error) {
        console.error('ç¶²è·¯éŒ¯èª¤:', error); // åŠ ä¸Šé€™è¡Œ
        showAlert('ç¶²è·¯é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦å•Ÿå‹•', 'error');
      }
    }

    function getFullAnswerText() {
      const container = document.getElementById('answer-paragraphs');
      const paragraphs = Array.from(container.querySelectorAll('span'));
      const paragraphText = paragraphs.map(p => p.textContent.trim()).join('\n').trim();

      if (paragraphText) {
        return paragraphText;
      }

      // è‹¥ç„¡æ®µè½ï¼Œå›å‚³ textarea è¼¸å…¥å…§å®¹
      return document.getElementById('answer-content').value.trim();
    }

    
    async function stopRecordingAndUpload() {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        alert('å°šæœªé–‹å§‹éŒ„éŸ³');
        return;
      }

      mediaRecorder.stop();
      if (mediaRecorder.stream) {
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
      }
      
      document.getElementById('start-record').classList.remove('hidden');
      document.getElementById('stop-record').classList.add('hidden');
      
      showAlert('æ­£åœ¨è½‰æ›èªéŸ³ä¸¦æäº¤ç­”æ¡ˆï¼Œè«‹ç¨å€™...', 'success');
      
      // æ–°å¢ï¼šç­‰å¾…éŒ„éŸ³è™•ç†å®Œæˆå¾Œè‡ªå‹•æäº¤
      setTimeout(async () => {
        const fullAnswer = getFullAnswerText();
        if (fullAnswer.trim()) {
          await submitAnswer();
        }
      }, 2000);
    }
      
    // ç²å–é€²åº¦
    async function fetchProgress() {
      try {
        const response = await fetch('http://localhost:5000/biography/progress', {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await response.json();
        window.currentRemaining = data.remaining ?? 0;
        window.avgAqi           = data.avg_aqi  ?? 0;
        console.log('Progress response:', data);

        if (!response.ok) {
          alert(data.error || 'ç„¡æ³•ç²å–é€²åº¦');
          return;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¨ˆç®—é¡¯ç¤ºç”¨æ•¸å€¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const pct        = (data.theme_coverage * 100).toFixed(1);          // 0â€“100 %
        const answered   = data.answered ?? 0;                              // å·²ç­”é¡Œæ•¸
        const remaining  = data.remaining ?? 0;                             // æœªç­”é¡Œæ•¸
        const total      = answered + remaining;                            // ç¸½é¡Œæ•¸
        const avgAqi     = data.avg_aqi ?? 0;                               // 0â€“1
        const stars      = Math.round(avgAqi * 5);                          // 0â€“5
        const starHTML   = Array.from({ length: 5 }, (_, i) =>
                              `<span class="star ${i < stars ? 'on' : ''}">â˜…</span>`).join('');

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ çµ„è£ HTML  â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const html = `
          <div class="text-xl font-semibold mb-1">
            å·²å®Œæˆ ${answered} / ${total} é¡Œï¼ˆ${pct}%ï¼‰
          </div>
          <div class="text-sm text-gray-600 mb-2">
            å°šé¤˜ ${remaining} é¡Œ
          </div>
          <div class="flex items-center gap-2 mb-1">
            ${starHTML}
            <span class="text-sm text-gray-700">${(avgAqi * 100).toFixed(1)} åˆ†</span>
          </div>
          <div class="progress-bar">
            <div style="width:${pct}%;"></div>
          </div>
        `;
        document.getElementById('progress-info').innerHTML = html;

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ è‹¥å…¨éƒ¨å®Œæˆï¼Œå¯æç¤º â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        if (remaining === 0 && total !== 0) {
          showAlert('ğŸ‰ ç´ æè’é›†å®Œæˆï¼Œå¿«ä¾†ç”Ÿæˆè‡ªå‚³å§ï¼', 'success');
        }

      } catch (error) {
        console.error('Fetch progress error:', error);
        alert('éŒ¯èª¤ï¼š' + error.message);
      }
    }


    /* ============ ç”Ÿæˆè‡ªå‚³ ============ */
    async function generateBiography() {
      // â‘  å…ˆæ›´æ–°æœ€æ–°é€²åº¦ï¼Œç¢ºå®šæ˜¯å¦é”é–€æª»
      await fetchProgress();
      //if (window.currentRemaining > 0) {
        //showAlert(`è‡³å°‘é‚„è¦å›ç­” ${window.currentRemaining} é¡Œæ‰èƒ½ç”Ÿæˆè‡ªå‚³å–”ï¼`, 'error');
        //return;
      //}

      // â‘¡ çµ„åˆå‰ç«¯è¡¨å–®å€¼
      const payload = {
        style:   document.getElementById('biography-style').value,   // é¢¨æ ¼
        lang:    document.getElementById('biography-language').value,    // èªè¨€
        length:  document.getElementById('biography-length').value,  // å­—æ•¸
        tone:    document.getElementById('biography-emotion').value,    // æƒ…æ„Ÿ
        usage:   document.getElementById('biography-usage').value,   // ç”¨é€”
        purpose: document.getElementById('biography-aim').value  // ç›®çš„
      };

      // â‘¢ é¡¯ç¤º Loading
      showAlert('âœï¸ è‡ªå‚³ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™â€¦', 'info');

      try {
        const res = await fetch('http://localhost:5000/biography/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (res.ok) {
          showAlert('ğŸ‰ è‡ªå‚³ç”ŸæˆæˆåŠŸï¼', 'success');
          previewBiography(data.version_id);     // â‘£ è‡ªå‹•é è¦½
        } else {
          showAlert(data.error || `ç”Ÿæˆå¤±æ•— (HTTP ${res.status})`, 'error');
        }
      } catch (err) {
        console.error(err);
        showAlert('ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      }
    }

    /* ============ é è¦½è‡ªå‚³ ============ */
  /* =========  é è¦½æŒ‡å®šç‰ˆæœ¬  ========= */
    async function previewBiography(versionId) {
      // å¦‚æœæ²’å¸¶ versionId å°±èµ°æœ€æ–°
      if (!versionId) return previewLatestBiography();

      try {
        const res  = await fetch(`http://localhost:5000/biography/preview?id=${versionId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();

        if (!res.ok) {
          showAlert(data.error || `å–å¾—é è¦½å¤±æ•— (HTTP ${res.status})`, 'error');
          return;
        }

        // 1ï¸âƒ£ å…§åµŒé¡¯ç¤º
        document.getElementById('preview-wrapper').classList.remove('hidden');
        document.getElementById('preview-content').value = data.content || data.text || '';

        // 2ï¸âƒ£ å¦é–‹è¦–çª—ï¼ˆå¯é¸ï¼‰
        const win = window.open('', '_blank');
        if (win) {
          win.document.open();
          win.document.write(data.html || `<pre style="white-space: pre-wrap;">${(data.content || '').replace(/</g,'&lt;')}</pre>`);
          win.document.close();
        } else {
          showAlert('âš ï¸ ç€è¦½å™¨å·²å°é–å½ˆå‡ºè¦–çª—ï¼Œåƒ…é¡¯ç¤ºå…§åµŒé è¦½', 'error');
        }

      } catch (e) {
        console.error(e);
        showAlert('ç„¡æ³•è¼‰å…¥é è¦½', 'error');
      }
    }

    /* =========  é è¦½æœ€æ–°ç‰ˆæœ¬  ========= */
    async function previewLatestBiography() {
      try {
        const res  = await fetch('http://localhost:5000/biography/preview/latest', {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();

        if (!res.ok) {
          showAlert(data.error || `å–å¾—é è¦½å¤±æ•— (HTTP ${res.status})`, 'error');
          return;
        }
        document.getElementById('preview-wrapper').classList.remove('hidden');
        document.getElementById('preview-content').value = data.content || '';

      } catch (e) {
        console.error(e);
        showAlert('ç„¡æ³•è¼‰å…¥é è¦½', 'error');
      }
    }

    function renderBiographyContent(content) {
      console.log("åœ–ç‰‡è·¯å¾‘ï¼š", content.match(/static\/uploads\/[^)\s]+\.(png|jpg|jpeg|gif)/g));

      // âœ… è‡ªå‹•è£œä¸Šçµ•å°ç¶²å€
      content = content.replace(/!\[.*?\]\((static\/uploads[^)]+)\)/g,
        '<br><img src="http://localhost:5000/$1" alt="åœ–ç‰‡" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 5px;"><br>');

      // âœ… è™•ç†æ›è¡Œ
      content = content.replace(/\n/g, '<br>');

      return content;
    }

    function renderStars(avgAqi) {
      const stars = Math.round(avgAqi * 5); // 0~5
      let html = '';
      for (let i = 1; i <= 5; i++) {
        html += `<span class="star ${i <= stars ? 'on' : ''}">â˜…</span>`;
      }
      return html;
    }
    async function fetchPlans() {
      console.log('Fetching plans');
      try {
        const response = await fetch('http://localhost:5000/plans/plans', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        console.log('Plans response:', data);
        if (response.ok) {
          const planList = document.getElementById('plan-list');
          const planSelect = document.getElementById('plan-id');
          planList.innerHTML = '';
          planSelect.innerHTML = '';
          data.plans.forEach(plan => {
            planList.innerHTML += `<p>${plan.name} (å­—æ•¸é™åˆ¶ï¼š${plan.word_limit || 'ç„¡é™åˆ¶'})</p>`;
            const option = document.createElement('option');
            option.value = plan.id;
            option.textContent = plan.name;
            planSelect.appendChild(option);
          });
        } else {
          alert(data.error || 'ç„¡æ³•ç²å–è¨ˆåŠƒ');
        }
      } catch (error) {
        console.error('Fetch plans error:', error);
        alert('éŒ¯èª¤ï¼š' + error.message);
      }
    }

    // é¸æ“‡è¨ˆåŠƒ
    async function selectPlan() {
      const planId = document.getElementById('plan-id').value;

      console.log('Selecting plan:', { planId });
      try {
        const response = await fetch('http://localhost:5000/plans/select-plan', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ plan_id: parseInt(planId) })
        });
        const data = await response.json();
        console.log('Select plan response:', data);
        if (response.ok) {
          alert('è¨ˆåŠƒé¸æ“‡æˆåŠŸï¼');
          fetchPlans();
        } else {
          alert(data.error || 'é¸æ“‡è¨ˆåŠƒå¤±æ•—');
        }
      } catch (error) {
        console.error('Select plan error:', error);
        alert('éŒ¯èª¤ï¼š' + error.message);
      }
    }
  </script>
</body>
</html>